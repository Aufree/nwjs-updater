<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Hello World</title>
</head>
<body>
    <h1 id="header">Hello World</h1>
    <p id="local_text"></p>
  <script>
  
  var gui = require('nw.gui');
  var copyPath, execPath;

  if(gui.App.argv.length){
    copyPath = gui.App.argv[0];
    execPath = gui.App.argv[1];
  }
  console.log("Copy path is " +  gui.App.argv[0]);
  console.log("Exec path is " +  gui.App.argv[1]);

  //download new version of app in tmp
  //unpack
  //run updater
  //updater will copy itself to origin directory
  //updater will run app
  var pkg = require('./package.json');
  var request = require('request');
  var url = require('url');
  var path = require('path');
  var os = require('os');
  var fs = require('fs');
  var k = 0;
  var d = false;
  var updater = require('./updater.js');
  var upd = new updater(pkg);
  var newVersionCheckIntervalId = null;
  var tryingForNewVersion = false;

  require('fs').readFile(upd.getAppPath() + "/sample.txt", function(error, data) {
    if (!error) {
      document.getElementById('local_text').innerHTML = data;
    } else {
      console.log(error);
    };
  });
  
  //for test purposes
  
  // 普通点击运行
  if(!copyPath){
    request.get(url.resolve(pkg.manifestUrl, '/version/'+ pkg.version));
    newVersionCheckIntervalId = setInterval(function(){
      if(!d && !tryingForNewVersion) {
          tryingForNewVersion = true; //lock
          upd.checkNewVersion(versionChecked);
      }
    }, 500);
    
  } 
  // 有更新,子线程中运行
  else {
    upd.install(copyPath, newAppInstalled);
    
    document.getElementById('header').innerHTML = "Installing...";
        
    function newAppInstalled(err){
      if(err){
        console.log("Run app installed faluire" + err);
        return;
      }

      upd.run(execPath, []);
      gui.App.quit();
    }
  }

  function versionChecked(err, newVersionExists, manifest){
    tryingForNewVersion = false; //unlock
    if(err){
        console.log(err);
        return Error(err);
    }
    else if(d){
        console.log('Already downloading');
        return;
    }
    else if(!newVersionExists){
        console.log('No new version exists');
        return;
    }

    d = true;
    clearInterval(newVersionCheckIntervalId);
    var loaded = 0;
    var newVersion = upd.download(function(error, filename){
        newVersionDownloaded(error, filename, manifest);
    }, manifest);
    newVersion.on('data', function(chunk){
      console.log("New version loading " + Math.floor(loaded / newVersion['content-length'] * 100) + '%');
      loaded+=chunk.length;
    })
  }

  console.log('New version start download');
  function newVersionDownloaded(err, filename, manifest){
    if(err){
      console.log("Something wrong" + err)
      return Error(err);
    }
    console.log('New version downloaded');
    upd.unpack(filename, newVersionUnpacked, manifest);
  }

  function newVersionUnpacked(err, newAppPath){
    if(err){
      console.log(err)
      return Error(err);
    }
    console.log('New version unpack');
    upd.runInstaller(newAppPath, [upd.getAppPath(), upd.getAppExec()]);
    gui.App.quit();
  }
</script>

</body>
</html>